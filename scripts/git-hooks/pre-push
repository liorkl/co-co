#!/bin/sh
# Git pre-push guardrails + PR description automation

set -eu

BRANCH="$(git branch --show-current 2>/dev/null || printf '')"
MAIN_BRANCH="main"
DEVELOP_BRANCH="develop"

# Allow bypassing when explicitly requested (e.g. CI, emergency)
if [ "${SKIP_PRE_PUSH_GUARDS:-0}" = "1" ]; then
  exit 0
fi

# Block direct pushes to protected branches unless explicitly allowed
if [ "$BRANCH" = "$MAIN_BRANCH" ] || [ "$BRANCH" = "$DEVELOP_BRANCH" ]; then
  if [ "${ALLOW_PROTECTED_BRANCH_PUSH:-0}" != "1" ]; then
    echo "‚ùå Direct pushes to '$BRANCH' are blocked by repository guardrails."
    echo "   Create a feature branch (e.g. feat/auth-improve-magic-link) and open a PR instead."
    echo "   Override once with: ALLOW_PROTECTED_BRANCH_PUSH=1 git push <remote> <branch>"
    exit 1
  fi
fi

# Enforce descriptive branch naming for feature branches
BRANCH_PATTERN='^(feat|fix|chore|docs|refactor|test|ci|infra)/[a-z0-9]+(-[a-z0-9]+){3,}$'
MIN_BRANCH_LENGTH=24
if [ "$BRANCH" != "$MAIN_BRANCH" ] && [ "$BRANCH" != "$DEVELOP_BRANCH" ]; then
  if [ "${SKIP_BRANCH_NAME_CHECK:-0}" != "1" ]; then
    if ! printf "%s" "$BRANCH" | grep -Eq "$BRANCH_PATTERN"; then
      echo "‚ùå Branch name '$BRANCH' is too generic."
      echo "   Use format: <type>/<area>-<action>-<context>-<outcome>"
      echo "   Examples:"
      echo "     feat/matching-expand-skill-filters-to-unblock-discovery"
      echo "     fix/auth-magic-link-copy-to-raise-activation-rate"
      echo "     chore/devops-prepush-guardrails-to-educate-team"
      echo "   Override once with SKIP_BRANCH_NAME_CHECK=1 (not recommended)."
      exit 1
    fi

    if [ "${#BRANCH}" -lt "$MIN_BRANCH_LENGTH" ]; then
      echo "‚ùå Branch name '$BRANCH' is too short to describe the work."
      echo "   Include what changes and the why (impact or motivating incident)."
      echo "   Override once with SKIP_BRANCH_NAME_CHECK=1 (not recommended)."
      exit 1
    fi
  fi
fi

# Ensure the latest commit summary captures intent + rationale
if [ "${SKIP_COMMIT_MESSAGE_CHECK:-0}" != "1" ]; then
  LAST_COMMIT_MSG="$(git log -1 --pretty=%s || printf '')"
  if [ -z "$LAST_COMMIT_MSG" ]; then
    echo "‚ùå Unable to read the last commit message."
    exit 1
  fi

  if [ "${#LAST_COMMIT_MSG}" -lt 50 ]; then
    echo "‚ùå Commit summary is too short to convey intent and rationale:"
    echo "   $LAST_COMMIT_MSG"
    echo "   Summaries must be at least 50 characters."
    echo "   Override once with SKIP_COMMIT_MESSAGE_CHECK=1 (not recommended)."
    exit 1
  fi

  if ! printf "%s" "$LAST_COMMIT_MSG" | grep -Eq '(because|so that|to )'; then
    echo "‚ùå Commit summary must explain the why."
    echo "   Add phrasing such as '... because ...', '... so that ...', or '... to ...'."
    echo "   Example: fix(auth): harden token hashing so that magic link reuse is blocked"
    echo "   Override once with SKIP_COMMIT_MESSAGE_CHECK=1 (not recommended)."
    exit 1
  fi
fi

# Ensure branch includes the latest main changes before pushing
if [ "${SKIP_MAIN_SYNC_CHECK:-0}" != "1" ]; then
  MAIN_SYNC_REMOTE="${GIT_MAIN_SYNC_REMOTE:-origin}"
  MAIN_SYNC_TARGET="${GIT_MAIN_SYNC_TARGET:-$MAIN_BRANCH}"

  if git remote get-url "$MAIN_SYNC_REMOTE" >/dev/null 2>&1; then
    echo "üîÑ Refreshing '$MAIN_SYNC_REMOTE/$MAIN_SYNC_TARGET'..."
    if git fetch "$MAIN_SYNC_REMOTE" "$MAIN_SYNC_TARGET" --quiet; then
      if ! git merge-base --is-ancestor "$MAIN_SYNC_REMOTE/$MAIN_SYNC_TARGET" HEAD; then
        echo "‚ùå Branch '$BRANCH' is missing the latest commits from '$MAIN_SYNC_REMOTE/$MAIN_SYNC_TARGET'."
        echo "   Rebase or merge the latest '$MAIN_SYNC_TARGET' before pushing:"
        echo "     git fetch $MAIN_SYNC_REMOTE $MAIN_SYNC_TARGET"
        echo "     git rebase $MAIN_SYNC_REMOTE/$MAIN_SYNC_TARGET"
        echo "   Override once with SKIP_MAIN_SYNC_CHECK=1 (not recommended)."
        exit 1
      fi
    else
      echo "‚ö†Ô∏è  Unable to fetch '$MAIN_SYNC_REMOTE/$MAIN_SYNC_TARGET'; skipping freshness check."
    fi
  fi
fi

# Run verification steps unless explicitly skipped
if [ "${SKIP_PRE_PUSH_CHECKS:-0}" != "1" ]; then
  if command -v npm >/dev/null 2>&1; then
    echo "üîç Running pre-push verification (lint, types, tests)..."

    if ! npm run lint --silent >/dev/null 2>&1; then
      echo "‚ùå Lint failed. Fix issues or set SKIP_PRE_PUSH_CHECKS=1 to bypass (not recommended)."
      exit 1
    fi

    if ! npx tsc --noEmit >/dev/null 2>&1; then
      echo "‚ùå Type check failed. Fix issues before pushing."
      exit 1
    fi

    if ! npm run --if-present test:unit --silent >/dev/null 2>&1; then
      echo "‚ùå Unit tests failed. Fix issues before pushing."
      exit 1
    fi

    if [ "${SKIP_E2E_SMOKE_CHECK:-0}" != "1" ]; then
      echo "üé≠ Running local e2e smoke test..."
      if ! npm run --if-present test:e2e:smoke; then
        echo "‚ùå E2E smoke test failed. Fix issues before pushing."
        echo "   Override once with SKIP_E2E_SMOKE_CHECK=1 (not recommended)."
        exit 1
      fi
    else
      echo "‚è≠Ô∏è  Skipping e2e smoke test (SKIP_E2E_SMOKE_CHECK=1)."
    fi
  else
    echo "‚ö†Ô∏è  npm not found; skipping automated lint/type/test checks."
  fi
fi

# Auto-generate PR description for feature branches when necessary
if [ "$BRANCH" != "$MAIN_BRANCH" ] && [ "$BRANCH" != "$DEVELOP_BRANCH" ]; then
  NEEDS_PR_DESCRIPTION=0

  if [ ! -f "PR_DESCRIPTION.md" ]; then
    NEEDS_PR_DESCRIPTION=1
  else
    LATEST_COMMIT_TIME="$(git log -1 --format=%ct HEAD 2>/dev/null || printf '0')"
    FILE_MTIME="$(stat -f %m "PR_DESCRIPTION.md" 2>/dev/null || stat -c %Y "PR_DESCRIPTION.md" 2>/dev/null || printf '0')"

    if [ "$LATEST_COMMIT_TIME" -gt "$FILE_MTIME" ]; then
      NEEDS_PR_DESCRIPTION=1
    fi
  fi

  if [ "$NEEDS_PR_DESCRIPTION" = "1" ]; then
    echo "üìù Auto-generating PR description..."
    if command -v npm >/dev/null 2>&1; then
      if npm run pr:description >/dev/null 2>&1; then
        echo "‚úÖ PR description generated in PR_DESCRIPTION.md"
      else
        echo "‚ö†Ô∏è  Failed to generate PR description automatically. Run 'npm run pr:description' manually."
      fi
    else
      echo "‚ö†Ô∏è  npm not found. Run 'npm run pr:description' manually."
    fi
  fi
fi

exit 0

