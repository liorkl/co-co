#!/bin/sh
# Prefill commit messages based on branch naming convention.

set -eu

COMMIT_MSG_FILE="$1"
COMMIT_SOURCE="${2:-}"

# Skip for merge, squash, or rebase commits that already have templates
case "$COMMIT_SOURCE" in
  merge|squash|commit)
    exit 0
    ;;
esac

# Only act if commit message is empty / whitespace
if [ -s "$COMMIT_MSG_FILE" ]; then
  if [ -n "$(tr -d '[:space:]' < "$COMMIT_MSG_FILE")" ]; then
    exit 0
  fi
fi

BRANCH="$(git branch --show-current 2>/dev/null || printf '')"

BRANCH_PATTERN='^(feat|fix|chore|docs|refactor|test)/[a-z0-9]+(-[a-z0-9]+){2,}$'
if ! printf "%s" "$BRANCH" | grep -Eq "$BRANCH_PATTERN"; then
  exit 0
fi

TYPE_PART="${BRANCH%%/*}"
REST_PART="${BRANCH#*/}"
TYPE_LOWER=$(printf "%s" "$TYPE_PART" | tr '[:upper:]' '[:lower:]')
REST_MESSAGE=$(printf "%s" "$REST_PART" | tr '-' ' ')

printf "%s: %s\n" "$TYPE_LOWER" "$REST_MESSAGE" > "$COMMIT_MSG_FILE"


